# =============================================================================
# Aula: Compara√ß√£o de Grupos - ANOVA e Testes N√£o Param√©tricos
# Curso: Estat√≠stica Aplicada
# Estudo de Caso: Metabric
# =============================================================================

# =============================================================================
# Objetivo:
# Comparar a idade no diagn√≥stico entre diferentes subtipos moleculares
# usando testes param√©tricos (ANOVA) e n√£o param√©tricos (Kruskal-Wallis).
#
# NOTAS DID√ÅTICAS:
# üß† Quando usar cada teste?
# - Use ANOVA padr√£o: se normalidade e homogeneidade de vari√¢ncias forem atendidas.
# - Use ANOVA com Games-Howell: se a normalidade for atendida, mas a homogeneidade n√£o.
# - Use Kruskal-Wallis com p√≥s-teste de Dunn: se a normalidade N√ÉO for atendida.
# =============================================================================


# =============================================================================
# Carregando Bibliotecas
# =============================================================================

library(rstatix)
library(flextable)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(DescTools)
library(ggstatsplot)
library(effectsize)

# =============================================================================
# Resumo estat√≠stico por Subtipo Molecular PAM50
# =============================================================================

metabric %>% 
  group_by(Pam50...Claudin.low.subtype) %>%
  get_summary_stats(Idade.no.Diagn√≥stico) %>%
  as.data.frame() %>%
  flextable()

# =============================================================================
# Teste de Normalidade (Shapiro-Wilk por grupo)
# Verifica se os dados seguem distribui√ß√£o normal em cada grupo.
# =============================================================================

metabric %>%
  group_by(Pam50...Claudin.low.subtype) %>%
  shapiro_test(Idade.no.Diagn√≥stico) %>%
  flextable()

# =============================================================================
# Teste de Homogeneidade de Vari√¢ncias (Levene)
# Verifica se as vari√¢ncias s√£o iguais entre os grupos.
# =============================================================================

metabric %>%
  levene_test(Idade.no.Diagn√≥stico ~ Pam50...Claudin.low.subtype) %>%
  flextable()

# =============================================================================
# Gr√°fico Q-Q Plot para normalidade visual
# =============================================================================

metabric %>%
  ggplot(aes(sample = Idade.no.Diagn√≥stico)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~Pam50...Claudin.low.subtype) +
  theme_minimal()

# =============================================================================
# Boxplot da Idade no Diagn√≥stico por Subtipo Molecular
# =============================================================================

metabric %>%
  ggplot(aes(x = Pam50...Claudin.low.subtype, y = Idade.no.Diagn√≥stico)) +
  geom_boxplot() +
  theme_minimal() +
  labs(x = "Subtipo Molecular PAM50/Claudin-low", y = "Idade no Diagn√≥stico")

# =============================================================================
# ANOVA (param√©trico) - se normalidade e homogeneidade forem atendidas
# =============================================================================

anova_res <- metabric %>% anova_test(Idade.no.Diagn√≥stico ~ Pam50...Claudin.low.subtype)
anova_res %>% flextable()

# =============================================================================
# Tamanho do Efeito
# Eta¬≤: propor√ß√£o da vari√¢ncia explicada pelo modelo.
# Omega¬≤: estimativa menos enviesada da vari√¢ncia explicada.
# =============================================================================

eta_squared(anova_res)
omega_squared(anova_res)

# =============================================================================
# P√≥s-Teste Param√©trico: Games-Howell
# Indicado quando h√° quebra de homogeneidade de vari√¢ncias.
# =============================================================================

games_post <- metabric %>% 
  games_howell_test(Idade.no.Diagn√≥stico ~ Pam50...Claudin.low.subtype)
games_post %>% flextable()

# =============================================================================
# Kruskal-Wallis (n√£o param√©trico) - se normalidade n√£o for atendida
# =============================================================================

kruskal_res <- metabric %>%
  kruskal_test(Idade.no.Diagn√≥stico ~ Pam50...Claudin.low.subtype)
kruskal_res %>% flextable()

# =============================================================================
# P√≥s-Teste N√£o Param√©trico: Dunn (Gunn) com ajuste de Holm
# Usado ap√≥s Kruskal-Wallis para compara√ß√µes m√∫ltiplas.
# =============================================================================

dunn_post <- metabric %>%
  dunn_test(Idade.no.Diagn√≥stico ~ Pam50...Claudin.low.subtype, p.adjust.method = "holm")
dunn_post %>% flextable()

# =============================================================================
# Gr√°fico Estat√≠stico Comparativo entre Grupos com Medidas de Efeito
# O par√¢metro 'var.equal = FALSE' ativa automaticamente o teste de Games-Howell.
# =============================================================================

ggbetweenstats(
  data = metabric,
  x = Pam50...Claudin.low.subtype,
  y = Idade.no.Diagn√≥stico,
  type = 'parametric',   # Pode mudar para 'nonparametric' se preferir
  var.equal = FALSE,     # FALSE ativa Games-Howell
  effsize.type = 'omega',
  results.subtitle = TRUE,
  bf.message = FALSE,
  xlab = "Subtipo Molecular PAM50/Claudin-low",
  ylab = "Idade no Diagn√≥stico (anos)",
  ggtheme = ggplot2::theme_minimal() +
    ggplot2::theme(
      axis.title = element_text(size = 16),
      axis.text = element_text(size = 14),
      plot.subtitle = element_text(size = 14)
    )
)

